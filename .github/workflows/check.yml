name: Pull Request Checks

on:
  workflow_call:
    secrets:
      CODECOV_TOKEN:
        required: true
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - run: corepack enable
      - run: yarn config set enableImmutableInstalls false
      - run: yarn
      - run: yarn build
      - run: yarn lint
      - run: yarn test --coverage
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  test-config-error-tsx:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - run: corepack enable
      - run: yarn config set enableImmutableInstalls false
      - run: yarn
      - run: yarn build
      - name: Test config-error with tsx
        run: |
          set +e
          output=$(npx tsx testing/pipelines/config-error.mts 2>&1)
          exit_code=$?
          echo "Exit code: $exit_code"
          echo "Output: $output"
          if [ $exit_code -eq 0 ]; then
            echo "ERROR: Expected non-zero exit code but got 0"
            exit 1
          fi
          if ! echo "$output" | grep -q "REQUIRED_CONFIGURATION_MISSING"; then
            echo "ERROR: Expected 'REQUIRED_CONFIGURATION_MISSING' in output"
            exit 1
          fi
          echo "SUCCESS: tsx test passed - got expected error and exit code"
      - name: Test thrown-bootstrap-error with tsx
        run: |
          set +e
          output=$(npx tsx testing/pipelines/thrown-bootstrap-error.mts 2>&1)
          exit_code=$?
          echo "Exit code: $exit_code"
          echo "Output: $output"
          if [ $exit_code -eq 0 ]; then
            echo "ERROR: Expected non-zero exit code but got 0"
            exit 1
          fi
          if ! echo "$output" | grep -q "BOOM"; then
            echo "ERROR: Expected 'BOOM' in output"
            exit 1
          fi
          echo "SUCCESS: tsx thrown-bootstrap-error test passed"
      - name: Test simple-success with tsx
        run: |
          set +e
          output=$(npx tsx testing/pipelines/simple-success.mts 2>&1)
          exit_code=$?
          echo "Exit code: $exit_code"
          echo "Output: $output"
          if [ $exit_code -ne 0 ]; then
            echo "ERROR: Expected zero exit code but got $exit_code"
            exit 1
          fi
          if ! echo "$output" | grep -q "this should be seen"; then
            echo "ERROR: Expected 'this should be seen' in output"
            exit 1
          fi
          echo "SUCCESS: tsx simple-success test passed"

  test-config-error-deno:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - run: deno install
      - name: Test config-error with deno
        run: |
          set +e
          output=$(deno run --allow-read --allow-env testing/pipelines/config-error.mts 2>&1)
          exit_code=$?
          echo "Exit code: $exit_code"
          echo "Output: $output"
          if [ $exit_code -eq 0 ]; then
            echo "ERROR: Expected non-zero exit code but got 0"
            exit 1
          fi
          if ! echo "$output" | grep -q "REQUIRED_CONFIGURATION_MISSING"; then
            echo "ERROR: Expected 'REQUIRED_CONFIGURATION_MISSING' in output"
            exit 1
          fi
          echo "SUCCESS: deno test passed - got expected error and exit code"
      - name: Test thrown-bootstrap-error with deno
        run: |
          set +e
          output=$(deno run --allow-read --allow-env testing/pipelines/thrown-bootstrap-error.mts 2>&1)
          exit_code=$?
          echo "Exit code: $exit_code"
          echo "Output: $output"
          if [ $exit_code -eq 0 ]; then
            echo "ERROR: Expected non-zero exit code but got 0"
            exit 1
          fi
          if ! echo "$output" | grep -q "BOOM"; then
            echo "ERROR: Expected 'BOOM' in output"
            exit 1
          fi
          echo "SUCCESS: deno thrown-bootstrap-error test passed"
      - name: Test simple-success with deno
        run: |
          set +e
          output=$(deno run --allow-read --allow-env testing/pipelines/simple-success.mts 2>&1)
          exit_code=$?
          echo "Exit code: $exit_code"
          echo "Output: $output"
          if [ $exit_code -ne 0 ]; then
            echo "ERROR: Expected zero exit code but got $exit_code"
            exit 1
          fi
          if ! echo "$output" | grep -q "this should be seen"; then
            echo "ERROR: Expected 'this should be seen' in output"
            exit 1
          fi
          echo "SUCCESS: deno simple-success test passed"

  test-config-error-bun:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Test config-error with bun
        run: |
          set +e
          output=$(bun run testing/pipelines/config-error.mts 2>&1)
          exit_code=$?
          echo "Exit code: $exit_code"
          echo "Output: $output"
          if [ $exit_code -eq 0 ]; then
            echo "ERROR: Expected non-zero exit code but got 0"
            exit 1
          fi
          if ! echo "$output" | grep -q "REQUIRED_CONFIGURATION_MISSING"; then
            echo "ERROR: Expected 'REQUIRED_CONFIGURATION_MISSING' in output"
            exit 1
          fi
          echo "SUCCESS: bun test passed - got expected error and exit code"
      - name: Test thrown-bootstrap-error with bun
        run: |
          set +e
          output=$(bun run testing/pipelines/thrown-bootstrap-error.mts 2>&1)
          exit_code=$?
          echo "Exit code: $exit_code"
          echo "Output: $output"
          if [ $exit_code -eq 0 ]; then
            echo "ERROR: Expected non-zero exit code but got 0"
            exit 1
          fi
          if ! echo "$output" | grep -q "BOOM"; then
            echo "ERROR: Expected 'BOOM' in output"
            exit 1
          fi
          echo "SUCCESS: bun thrown-bootstrap-error test passed"
      - name: Test simple-success with bun
        run: |
          set +e
          output=$(bun run testing/pipelines/simple-success.mts 2>&1)
          exit_code=$?
          echo "Exit code: $exit_code"
          echo "Output: $output"
          if [ $exit_code -ne 0 ]; then
            echo "ERROR: Expected zero exit code but got $exit_code"
            exit 1
          fi
          if ! echo "$output" | grep -q "this should be seen"; then
            echo "ERROR: Expected 'this should be seen' in output"
            exit 1
          fi
          echo "SUCCESS: bun simple-success test passed"
