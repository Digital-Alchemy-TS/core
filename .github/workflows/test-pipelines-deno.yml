name: Test Pipelines - Deno

on:
  workflow_call:

permissions:
  contents: read

jobs:
  test-pipelines-deno:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - run: deno install
      - name: Test config-error with deno
        run: |
          set +e
          output=$(deno run --allow-read --allow-env testing/pipelines/config-error.mts 2>&1)
          exit_code=$?
          echo "Exit code: $exit_code"
          echo "Output: $output"
          if [ $exit_code -eq 0 ]; then
            echo "ERROR: Expected non-zero exit code but got 0"
            exit 1
          fi
          if ! echo "$output" | grep -q "REQUIRED_CONFIGURATION_MISSING"; then
            echo "ERROR: Expected 'REQUIRED_CONFIGURATION_MISSING' in output"
            exit 1
          fi
          echo "SUCCESS: deno test passed - got expected error and exit code"
      - name: Test thrown-bootstrap-error with deno
        run: |
          set +e
          output=$(deno run --allow-read --allow-env testing/pipelines/thrown-bootstrap-error.mts 2>&1)
          exit_code=$?
          echo "Exit code: $exit_code"
          echo "Output: $output"
          if [ $exit_code -eq 0 ]; then
            echo "ERROR: Expected non-zero exit code but got 0"
            exit 1
          fi
          if ! echo "$output" | grep -q "BOOM"; then
            echo "ERROR: Expected 'BOOM' in output"
            exit 1
          fi
          echo "SUCCESS: deno thrown-bootstrap-error test passed"
      - name: Test simple-success with deno
        run: |
          set +e
          output=$(deno run --allow-read --allow-env testing/pipelines/simple-success.mts 2>&1)
          exit_code=$?
          echo "Exit code: $exit_code"
          echo "Output: $output"
          if [ $exit_code -ne 0 ]; then
            echo "ERROR: Expected zero exit code but got $exit_code"
            exit 1
          fi
          if ! echo "$output" | grep -q "this should be seen"; then
            echo "ERROR: Expected 'this should be seen' in output"
            exit 1
          fi
          echo "SUCCESS: deno simple-success test passed"
